<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel PMO — Gestão de Capacidade (Folha)</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a30;
      --text:#e8efff;
      --muted:#93a4c7;
      --line:rgba(255,255,255,.10);

      --do:#60a5fa;
      --ge:#34d399;
      --jc:#fbbf24;
      --al:#fb7185;

      --danger:#ef4444;
      --ok:#22c55e;

      /* ultra-denso */
      --rowH:18px;
      --headH1:14px; /* DOW */
      --headH2:14px; /* DATE */

      --wClient:170px;
      --wTurno:86px;
      --wDate:64px;

      --solidBG:#0b1220;
      --solidHdr:#0a162e;
      --solidSticky:#0b1220;

      --mStrip:#2b2a57;
      --tStrip:#0f3348;

      --weekend:#2a2618;
      --free:#12321f;
      --freeHdr:#154027;
      --confHdr:#3a1212;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(900px 500px at 20% 0%, #14264a 0%, var(--bg) 60%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow:hidden;
    }

    /* ===== TOP BAR ===== */
    .top{
      padding:10px 12px 8px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(10,22,46,.98), rgba(10,22,46,.86));
    }
    .titleRow{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .title{
      font-weight:950; font-size:16px;
    }
    .subtitle{
      color:var(--muted); font-size:12px; font-weight:700;
    }

    .filters{
      display:grid;
      grid-template-columns: 1.3fr 0.9fr 0.7fr 0.7fr auto;
      gap:10px;
      align-items:end;
    }
    .field label{
      display:block;
      font-size:11px;
      color:var(--muted);
      margin:0 0 6px;
      font-weight:800;
    }
    .field input,.field select{
      width:100%;
      background:#0f1a30;
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      outline:none;
    }
    .btn{
      border:1px solid rgba(255,255,255,.45);
      background:transparent;
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }

    .chipRow{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }

    .chipBtn{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#0f1a30;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:12px;
      color:#fff;
      transition:transform .05s ease;
    }
    .chipBtn:active{ transform:scale(.98); }
    .chipBtn .dot{ width:10px;height:10px;border-radius:50%; }
    .chipBtn[aria-pressed="true"]{
      border-color: rgba(255,255,255,.55);
      background:#14264a;
    }

    .modeBtns{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-left:6px;
    }
    .modeBtn{
      display:inline-flex; align-items:center;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#0f1a30;
      cursor:pointer;
      user-select:none;
      font-size:12px;
      font-weight:950;
      color:#fbbf24; /* amarelo (como você queria) */
    }
    .modeBtn[aria-pressed="true"]{
      background:#14264a;
      border-color: rgba(255,255,255,.45);
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    .kpi{
      background:#0f1a30;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
    }
    .kpi .k{ color:var(--muted); font-size:11px; font-weight:800; }
    .kpi .v{ font-size:18px; font-weight:950; margin-top:6px; }

    /* ===== GRID ===== */
    .gridWrap{
      height: calc(100vh - 210px);
      padding:12px;
    }
    .gridCard{
      height: 100%;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:#0f1a30;
      display:flex;
      flex-direction:column;
    }
    .gridTitle{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      font-weight:950;
      background: var(--solidBG);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .status{
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
    }

    .tableScroll{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      background: var(--solidBG);
      overscroll-behavior: contain;
    }

    table{
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
      width:max-content;
      min-width: 100%;
    }

    thead tr{ height: var(--headH1); }
    thead tr:nth-child(2){ height: var(--headH2); }
    tbody tr{ height: var(--rowH); }

    thead th{
      position: sticky;
      background: var(--solidHdr);
      color: var(--muted);
      border-bottom:1px solid rgba(255,255,255,.16);
      border-right:1px solid rgba(255,255,255,.06);
      text-align:center;
      padding:0 6px;
      white-space:nowrap;
      font-size:10px;
      font-weight:950;
      z-index: 10;
    }
    thead tr:nth-child(1) th{
      top: 0;
      height: var(--headH1);
      line-height: var(--headH1);
      z-index: 20;
    }
    thead tr:nth-child(2) th{
      top: var(--headH1);
      height: var(--headH2);
      line-height: var(--headH2);
      z-index: 19;
    }

    /* HEADER Cliente/Turno — sticky TOP + LEFT (não some nunca) */
    thead th.thClient{
      left: 0;
      width: var(--wClient);
      min-width: var(--wClient);
      max-width: var(--wClient);
      text-align:left;
      padding-left:10px;
      z-index: 1000;
      background: var(--solidHdr);
      border-right:1px solid rgba(255,255,255,.14);
    }
    thead th.thTurno{
      left: var(--wClient);
      width: var(--wTurno);
      min-width: var(--wTurno);
      max-width: var(--wTurno);
      z-index: 999;
      background: var(--solidHdr);
      border-right:1px solid rgba(255,255,255,.14);
    }

    tbody td{
      height: var(--rowH);
      line-height: var(--rowH);
      font-size:11px;
      border-bottom:1px solid rgba(255,255,255,.06);
      border-right:1px solid rgba(255,255,255,.04);
      padding:0 4px;
      white-space:nowrap;
      background: var(--solidBG);
      vertical-align:middle;
    }

    /* COLUNAS FIXAS (Cliente/Turno) — sempre opacas */
    tbody td.tdClient{
      position: sticky;
      left: 0;
      width: var(--wClient);
      min-width: var(--wClient);
      max-width: var(--wClient);
      z-index: 50;
      background: var(--solidSticky) !important;
      border-right:1px solid rgba(255,255,255,.14);
    }
    tbody td.tdTurno{
      position: sticky;
      left: var(--wClient);
      width: var(--wTurno);
      min-width: var(--wTurno);
      max-width: var(--wTurno);
      z-index: 49;
      background: var(--solidSticky) !important;
      border-right:1px solid rgba(255,255,255,.14);
      text-align:center;
      font-weight:950;
    }

    .clientText{
      display:block;
      padding:0 6px;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:950;
      text-transform:uppercase;
    }

    /* Faixas manhã/tarde */
    tr.rowM td{ background: linear-gradient(90deg, var(--mStrip), var(--solidBG)); }
    tr.rowT td{ background: linear-gradient(90deg, var(--tStrip), var(--solidBG)); }
    tr.rowM td.tdClient, tr.rowM td.tdTurno,
    tr.rowT td.tdClient, tr.rowT td.tdTurno{
      background: var(--solidSticky) !important;
    }

    /* Weekend */
    .weekend{ background: var(--weekend) !important; }

    /* Período livre (Taxa Ociosidade) */
    .freeCell{ background: var(--free) !important; }
    .freeHdr{ background: var(--freeHdr) !important; color:#d1fae5 !important; }

    /* Conflito (Cap vs Dem) */
    .confHdr{ background: var(--confHdr) !important; color:#fee2e2 !important; }

    /* Chips */
    .cellChips{display:flex; align-items:center; justify-content:center; gap:2px;}
    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:22px; height:14px; padding:0 5px;
      border-radius:5px;
      border:1px solid rgba(255,255,255,.10);
      background:#14264a;
      font-weight:950;
      font-size:10px;
      line-height:14px;
      color:var(--text);
    }
    .chip.empty{opacity:.25}
    .chip.conflict{
      background: var(--danger) !important;
      color:#0b1220 !important;
      border-color: rgba(0,0,0,.15);
    }

    /* Linha escondida por filtro */
    tr.hidden{ display:none; }

    /* Colunas escondidas (janela) */
    .colHidden{ display:none; }
  </style>
</head>

<body>
  <div class="top">
    <div class="titleRow">
      <div>
        <div class="title">Painel PMO — Gestão de Capacidade (Folha)</div>
        <div class="subtitle" id="subTitle">Fonte: Google Sheets publicado (CSV). Filtro estrito por colaborador + modos especiais.</div>
      </div>
      <button class="btn" id="btnReload">Recarregar dados</button>
    </div>

    <div class="filters">
      <div class="field">
        <label>Busca (cliente)</label>
        <input id="qClient" placeholder="Ex.: HS MATEUS, ABBR, MEDILAR..." />
      </div>
      <div class="field">
        <label>Filtro por recurso (dropdown)</label>
        <select id="selRes">
          <option value="">Todos</option>
          <option value="DO">DO (Dôra)</option>
          <option value="GE">GE (Geovana)</option>
          <option value="JC">JC (João Custódio)</option>
          <option value="AL">AL (Aline)</option>
        </select>
      </div>
      <div class="field">
        <label>Data início (dd/mm)</label>
        <input id="dStart" placeholder="Ex.: 24/01" />
      </div>
      <div class="field">
        <label>Data fim (dd/mm)</label>
        <input id="dEnd" placeholder="Ex.: 29/04" />
      </div>
      <button class="btn" id="btnClear">Limpar</button>
    </div>

    <div class="chipRow">
      <button class="chipBtn" data-code="DO" aria-pressed="false" title="DO = Dôra">
        <span class="dot" style="background:var(--do)"></span> DO
      </button>
      <button class="chipBtn" data-code="GE" aria-pressed="false" title="GE = Geovana">
        <span class="dot" style="background:var(--ge)"></span> GE
      </button>
      <button class="chipBtn" data-code="JC" aria-pressed="false" title="JC = João Custódio">
        <span class="dot" style="background:var(--jc)"></span> JC
      </button>
      <button class="chipBtn" data-code="AL" aria-pressed="false" title="AL = Aline">
        <span class="dot" style="background:var(--al)"></span> AL
      </button>

      <div class="modeBtns">
        <button class="modeBtn" id="btnCap" aria-pressed="false">Capacidade vs. Demandas</button>
        <button class="modeBtn" id="btnIdle" aria-pressed="false">Taxa de Ociosidade</button>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="k">Linhas exibidas</div><div class="v" id="kRows">—</div></div>
      <div class="kpi"><div class="k">Colunas (janela)</div><div class="v" id="kCols">—</div></div>
      <div class="kpi"><div class="k">Células preenchidas</div><div class="v" id="kFilled">—</div></div>
      <div class="kpi"><div class="k">Hoje</div><div class="v" id="kToday">—</div></div>
    </div>
  </div>

  <div class="gridWrap">
    <div class="gridCard">
      <div class="gridTitle">
        <div>Grade de Alocação</div>
        <div class="status" id="status">Status: carregando…</div>
      </div>

      <div class="tableScroll" id="tableScroll">
        <table id="gridTable">
          <thead>
            <tr id="headDow"></tr>
            <tr id="headDate"></tr>
          </thead>
          <tbody id="body"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* ===================== CONFIG ===================== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSgqs7bjsPeaojEQG7buOiixxv7tg1F6jt2wogHKI7O2AvjS-_aq6o7knAO5HgrUd5jZ1iWge4ZgMHM/pub?gid=0&single=true&output=csv";
const RESOURCE_NAMES = { DO:"Dôra", GE:"Geovana", JC:"João Custódio", AL:"Aline" };
const VALID = new Set(["DO","GE","JC","AL"]);
const TURNOS = { M:"MANHÃ", T:"TARDE" };

/* ===================== STATE ===================== */
let rawRows = [];
let dows = [];
let dates = [];          // ["12/01", ...]
let dateIdxStart = -1;   // coluna inicial de datas
let bodyData = [];       // [{client, turnoNorm, turnoKey(M/T), cellsRaw:[], codesByCol:[["DO"],["AL","GE"]...]}]
let selectedCodes = new Set();
let mode = "";           // "", "cap", "idle"
let windowFrom = null;   // index inclusive
let windowTo = null;     // index inclusive
let conflicts = new Set();  // keys: `${code}|${col}|${turnoKey}`
let idleCols = new Set();   // keys: `${col}|${turnoKey}`

/* ===================== CSV PARSER ===================== */
function parseCSV(text){
  const rows=[];
  let row=[], cur="", inQ=false;
  for (let i=0;i<text.length;i++){
    const ch=text[i], nx=text[i+1];
    if (ch === '"' && nx === '"'){ cur+='"'; i++; continue; }
    if (ch === '"'){ inQ=!inQ; continue; }
    if (ch === ',' && !inQ){ row.push(cur); cur=""; continue; }
    if ((ch === '\n' || ch === '\r') && !inQ){
      if (cur.length || row.length){ row.push(cur); rows.push(row); }
      row=[]; cur=""; continue;
    }
    cur+=ch;
  }
  if (cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows.map(r=>r.map(c=>(c??"").trim()));
}

function normalizeDateLabel(s){
  const m=String(s||"").trim().match(/^(\d{1,2})\/(\d{1,2})/);
  if(!m) return String(s||"").trim();
  return `${String(m[1]).padStart(2,"0")}/${String(m[2]).padStart(2,"0")}`;
}

function isWeekend(dow){
  const x=String(dow||"").toUpperCase();
  return x.startsWith("SAB") || x.startsWith("SÁB") || x.startsWith("DOM");
}

function parseCellCodes(cellRaw){
  const raw=String(cellRaw||"").trim();
  if(!raw) return [];
  const normalized = raw.toUpperCase()
    .replace(/\u00A0/g," ")
    .replace(/[\n\r\t]/g," ")
    .replace(/[\/,;|]/g," ")
    .replace(/\s*-\s*/g," ");
  const parts=normalized.split(/\s+/).filter(Boolean);
  const out=[], seen=new Set();
  for(const p of parts){
    const code=p.replace(/[^A-Z]/g,"").slice(0,2);
    if(!VALID.has(code)) continue;
    if(seen.has(code)) continue;
    seen.add(code); out.push(code);
  }
  return out;
}

function toTurnoKey(turnoNorm){
  const t = String(turnoNorm||"").toUpperCase().trim();
  if (t==="M" || t==="MANHÃ" || t==="MANHA") return "M";
  if (t==="T" || t==="TARDE") return "T";
  return "";
}

function ddmmToIndex(ddmm){
  const x = String(ddmm||"").trim();
  const m = x.match(/^(\d{1,2})\/(\d{1,2})$/);
  if(!m) return null;
  const label = `${String(m[1]).padStart(2,"0")}/${String(m[2]).padStart(2,"0")}`;
  const idx = dates.indexOf(label);
  return idx>=0 ? idx : null;
}

/* ===================== RENDER HELPERS ===================== */
function chipEl(code, opts={}){
  const v=String(code||"").toUpperCase().trim();
  const sp=document.createElement("span");
  sp.className="chip"+(!v?" empty":"");
  sp.textContent=v || "—";
  if (v && RESOURCE_NAMES[v]) sp.title = `${v} = ${RESOURCE_NAMES[v]}`;
  if (opts.conflict) sp.classList.add("conflict");

  const css=getComputedStyle(document.documentElement);
  const colors={
    DO:css.getPropertyValue("--do").trim(),
    GE:css.getPropertyValue("--ge").trim(),
    JC:css.getPropertyValue("--jc").trim(),
    AL:css.getPropertyValue("--al").trim()
  };
  if(colors[v] && !opts.conflict){
    sp.style.background=colors[v];
    sp.style.color="#0b1220";
  }
  if(opts.conflict){
    sp.style.color="#0b1220";
  }
  return sp;
}

function setStatus(msg){ document.getElementById("status").textContent = msg; }

function updateKPIs(rowsShown, colsShown, filled, todayLabel){
  document.getElementById("kRows").textContent = String(rowsShown);
  document.getElementById("kCols").textContent = String(colsShown);
  document.getElementById("kFilled").textContent = String(filled);
  document.getElementById("kToday").textContent = todayLabel || "—";
}

/* ===================== BUILD DATA MODEL ===================== */
function buildBodyData(rows){
  const out = [];
  let lastClient="";
  for(let r=2;r<rows.length;r++){
    const row=rows[r];
    const first=row.findIndex(c=>c && c!=="");
    if(first<0) continue;

    let client=(row[first]||"").trim();
    let turno=(row[first+1]||"").trim();

    const t=(x)=>String(x||"").toUpperCase().trim();
    const isM = (x)=> (t(x)==="M" || t(x)==="MANHÃ" || t(x)==="MANHA");
    const isT = (x)=> (t(x)==="T" || t(x)==="TARDE");

    if(isM(client) || isT(client)){
      turno = client;
      client = lastClient || "—";
    }
    if(client && client!=="—") lastClient=client;

    const turnoKey = isM(turno) ? "M" : (isT(turno) ? "T" : toTurnoKey(turno));
    const turnoNorm = TURNOS[turnoKey] || String(turno||"").toUpperCase().trim() || "—";

    const cellsRaw = row.slice(dateIdxStart);
    const codesByCol = cellsRaw.map(c=>parseCellCodes(c));

    out.push({ client, turnoNorm, turnoKey, cellsRaw, codesByCol });
  }
  return out;
}

/* ===================== MODES: CONFLICTS & IDLE ===================== */
function computeConflicts(){
  conflicts.clear();
  // conflito = mesmo colaborador alocado em >1 cliente no mesmo dia + turno
  // usa janela ativa (windowFrom/windowTo)
  const from = windowFrom ?? 0;
  const to = windowTo ?? (dates.length-1);

  // map: key(code|col|turno) -> Set(client)
  const map = new Map();
  for(const row of bodyData){
    if(!row.turnoKey) continue;
    for(let col=from; col<=to; col++){
      const codes = row.codesByCol[col] || [];
      for(const code of codes){
        const k = `${code}|${col}|${row.turnoKey}`;
        if(!map.has(k)) map.set(k, new Set());
        map.get(k).add(row.client);
      }
    }
  }
  for(const [k, setClients] of map.entries()){
    if(setClients.size > 1){
      conflicts.add(k);
    }
  }
}

function computeIdleCols(){
  idleCols.clear();
  // período livre = nenhum analista alocado no dia+turno (time 100% ocioso)
  const from = windowFrom ?? 0;
  const to = windowTo ?? (dates.length-1);

  // map: key(col|turno) -> count allocations (qualquer code)
  const map = new Map();
  for(const row of bodyData){
    if(!row.turnoKey) continue;
    for(let col=from; col<=to; col++){
      const codes = row.codesByCol[col] || [];
      if(codes.length>0){
        const k = `${col}|${row.turnoKey}`;
        map.set(k, (map.get(k)||0) + codes.length);
      }
    }
  }

  // se não existe registro no map => zero => livre
  for(let col=from; col<=to; col++){
    for(const turnoKey of ["M","T"]){
      const k = `${col}|${turnoKey}`;
      if(!map.has(k)) idleCols.add(k);
    }
  }
}

/* ===================== APPLY FILTERS ===================== */
function applyWindowFromInputs(){
  const s = document.getElementById("dStart").value.trim();
  const e = document.getElementById("dEnd").value.trim();
  const sIdx = s ? ddmmToIndex(s) : null;
  const eIdx = e ? ddmmToIndex(e) : null;

  windowFrom = (sIdx!==null) ? sIdx : null;
  windowTo = (eIdx!==null) ? eIdx : null;

  if(windowFrom!==null && windowTo!==null && windowFrom>windowTo){
    // swap
    const tmp = windowFrom; windowFrom = windowTo; windowTo = tmp;
  }
}

function passesRowFilters(row, from, to){
  const q = document.getElementById("qClient").value.trim().toUpperCase();
  if(q && !String(row.client||"").toUpperCase().includes(q)) return false;

  const dd = document.getElementById("selRes").value.trim().toUpperCase();
  const ddSet = dd ? new Set([dd]) : null;

  // seleção final de códigos = (chips selecionados) OU (dropdown) OU ambos (interseção)
  let activeSet = null;
  if(selectedCodes.size>0) activeSet = new Set(selectedCodes);
  if(ddSet){
    if(activeSet){
      activeSet = new Set([...activeSet].filter(x=>ddSet.has(x)));
    }else{
      activeSet = ddSet;
    }
  }

  // modos especiais podem filtrar
  const capOn = (mode==="cap");
  const idleOn = (mode==="idle");

  // se não há set ativo e nenhum modo, não filtra por conteúdo
  if(!activeSet && !capOn && !idleOn) return true;

  // checar se a linha tem algo relevante na janela
  for(let col=from; col<=to; col++){
    const codes = row.codesByCol[col] || [];

    // modo idle: exibir linhas do turno que está livre (col|turno)
    if(idleOn){
      const k = `${col}|${row.turnoKey}`;
      if(idleCols.has(k)) return true;
      continue;
    }

    // modo cap: exibir apenas onde há conflito
    if(capOn){
      for(const c of codes){
        const k = `${c}|${col}|${row.turnoKey}`;
        if(conflicts.has(k)) return true;
      }
      continue;
    }

    // filtro estrito por colaborador
    if(activeSet){
      for(const c of codes){
        if(activeSet.has(c)) return true;
      }
    }
  }

  return false;
}

/* ===================== RENDER GRID ===================== */
function render(){
  applyWindowFromInputs();

  const from = windowFrom ?? 0;
  const to = windowTo ?? (dates.length-1);

  // recomputa modos
  if(mode==="cap") computeConflicts(); else conflicts.clear();
  if(mode==="idle") computeIdleCols(); else idleCols.clear();

  // ===== Header =====
  const headDow=document.getElementById("headDow");
  const headDate=document.getElementById("headDate");
  headDow.innerHTML=""; headDate.innerHTML="";

  const thClient=document.createElement("th");
  thClient.className="thClient";
  thClient.textContent="Cliente";
  thClient.rowSpan=2;

  const thTurno=document.createElement("th");
  thTurno.className="thTurno";
  thTurno.textContent="Turno";
  thTurno.rowSpan=2;

  headDow.appendChild(thClient);
  headDow.appendChild(thTurno);

  for(let col=0; col<dates.length; col++){
    const th=document.createElement("th");
    th.textContent=(dows[col]||"").toUpperCase();
    th.style.width=th.style.minWidth=th.style.maxWidth=getComputedStyle(document.documentElement).getPropertyValue("--wDate").trim() || "64px";

    const inWindow = (col>=from && col<=to);
    if(!inWindow) th.classList.add("colHidden");

    const wk = isWeekend(dows[col]);
    if(wk) th.classList.add("weekend");

    // headers especiais
    if(mode==="idle"){
      const kM = `${col}|M`, kT = `${col}|T`;
      if(idleCols.has(kM) || idleCols.has(kT)) th.classList.add("freeHdr");
    }
    if(mode==="cap"){
      // se houver qualquer conflito nesse col, marca header
      let any=false;
      for(const code of VALID){
        if(conflicts.has(`${code}|${col}|M`) || conflicts.has(`${code}|${col}|T`)){ any=true; break; }
      }
      if(any) th.classList.add("confHdr");
    }

    headDow.appendChild(th);
  }

  for(let col=0; col<dates.length; col++){
    const th=document.createElement("th");
    th.textContent=dates[col];
    th.style.width=th.style.minWidth=th.style.maxWidth=getComputedStyle(document.documentElement).getPropertyValue("--wDate").trim() || "64px";

    const inWindow = (col>=from && col<=to);
    if(!inWindow) th.classList.add("colHidden");

    const wk = isWeekend(dows[col]);
    if(wk) th.classList.add("weekend");

    if(mode==="idle"){
      const kM = `${col}|M`, kT = `${col}|T`;
      if(idleCols.has(kM) || idleCols.has(kT)) th.classList.add("freeHdr");
    }
    if(mode==="cap"){
      let any=false;
      for(const code of VALID){
        if(conflicts.has(`${code}|${col}|M`) || conflicts.has(`${code}|${col}|T`)){ any=true; break; }
      }
      if(any) th.classList.add("confHdr");
    }

    headDate.appendChild(th);
  }

  // ===== body =====
  const tbody=document.getElementById("body");
  tbody.innerHTML="";

  // construir set ativo (chips + dropdown)
  const dd = document.getElementById("selRes").value.trim().toUpperCase();
  const ddSet = dd ? new Set([dd]) : null;
  let activeSet = null;
  if(selectedCodes.size>0) activeSet = new Set(selectedCodes);
  if(ddSet){
    if(activeSet){
      activeSet = new Set([...activeSet].filter(x=>ddSet.has(x)));
    }else{
      activeSet = ddSet;
    }
  }

  let shownRows=0;
  let filled=0;

  for(const row of bodyData){
    if(!row.turnoKey) continue;

    if(!passesRowFilters(row, from, to)){
      continue;
    }

    const tr=document.createElement("tr");
    tr.className = (row.turnoKey==="M") ? "rowM" : "rowT";

    const tdClient=document.createElement("td");
    tdClient.className="tdClient";
    const span=document.createElement("span");
    span.className="clientText";
    span.textContent=row.client;
    tdClient.appendChild(span);

    const tdTurno=document.createElement("td");
    tdTurno.className="tdTurno";
    tdTurno.textContent=row.turnoNorm;

    tr.appendChild(tdClient);
    tr.appendChild(tdTurno);

    for(let col=0; col<dates.length; col++){
      const td=document.createElement("td");
      td.style.width=td.style.minWidth=td.style.maxWidth=getComputedStyle(document.documentElement).getPropertyValue("--wDate").trim() || "64px";

      const inWindow = (col>=from && col<=to);
      if(!inWindow) td.classList.add("colHidden");

      if(isWeekend(dows[col])) td.classList.add("weekend");

      // idle highlight (sem alocações no time)
      if(mode==="idle"){
        const k = `${col}|${row.turnoKey}`;
        if(idleCols.has(k)){
          td.classList.add("freeCell");
        }
      }

      const codesAll = row.codesByCol[col] || [];
      if(codesAll.length>0) filled += codesAll.length;

      // aplicar filtro estrito de colaborador (se tiver activeSet)
      let codes = codesAll;
      if(activeSet){
        codes = codesAll.filter(c=>activeSet.has(c));
      }

      // modo cap: mostrar apenas conflitos e pintar vermelho
      let outCodes = codes;
      if(mode==="cap"){
        outCodes = [];
        for(const c of codesAll){
          const k = `${c}|${col}|${row.turnoKey}`;
          if(conflicts.has(k)) outCodes.push(c);
        }
      }

      const box=document.createElement("div");
      box.className="cellChips";

      if(outCodes.length===0){
        box.appendChild(chipEl("", {}));
      }else{
        for(const c of outCodes){
          const isConf = (mode==="cap") ? conflicts.has(`${c}|${col}|${row.turnoKey}`) : false;
          box.appendChild(chipEl(c, { conflict:isConf }));
        }
      }

      td.appendChild(box);
      tr.appendChild(td);
    }

    tbody.appendChild(tr);
    shownRows++;
  }

  // KPIs
  const colsShown = (to - from + 1);
  const todayLabel = (() => {
    const now = new Date();
    const dd = String(now.getDate()).padStart(2,"0");
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const label = `${dd}/${mm}`;
    return dates.includes(label) ? label : label;
  })();

  updateKPIs(shownRows, colsShown, filled, todayLabel);

  // status
  if(mode==="cap"){
    setStatus(`Status: carregado • Modo: Conflitos (Capacidade vs. Demandas) • Conflitos: ${conflicts.size}`);
  }else if(mode==="idle"){
    setStatus(`Status: carregado • Modo: Ociosidade • Períodos livres (time): ${idleCols.size}`);
  }else{
    setStatus("Status: carregado");
  }
}

/* ===================== LOAD CSV ===================== */
async function load(){
  setStatus("Status: carregando…");
  try{
    const res=await fetch(CSV_URL, {cache:"no-store"});
    if(!res.ok) throw new Error("Falha ao buscar CSV");
    const csv=await res.text();

    rawRows=parseCSV(csv).filter(r=>r.some(c=>c && c!==""));
    if(rawRows.length<3){
      setStatus("Status: CSV vazio/curto");
      return;
    }

    const dowRow=rawRows[0];
    const dateRow=rawRows[1];

    dateIdxStart = dateRow.findIndex(c=>/^\d{1,2}\/\d{1,2}/.test(c));
    if(dateIdxStart<0){
      setStatus("Status: não encontrei linha de datas");
      return;
    }

    dows = dowRow.slice(dateIdxStart);
    dates = dateRow.slice(dateIdxStart).map(normalizeDateLabel);

    bodyData = buildBodyData(rawRows);

    render();
  }catch(e){
    console.error(e);
    setStatus("Status: erro ao carregar");
  }
}

/* ===================== UI EVENTS ===================== */
function wire(){
  // chips seleção
  document.querySelectorAll(".chipBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const code = btn.getAttribute("data-code");
      const on = btn.getAttribute("aria-pressed")==="true";
      btn.setAttribute("aria-pressed", on ? "false" : "true");
      if(on) selectedCodes.delete(code);
      else selectedCodes.add(code);

      // se estava em modo especial, mantém; apenas re-render
      render();
    });
  });

  // modos especiais
  const btnCap = document.getElementById("btnCap");
  const btnIdle = document.getElementById("btnIdle");

  btnCap.addEventListener("click", ()=>{
    const on = btnCap.getAttribute("aria-pressed")==="true";
    btnCap.setAttribute("aria-pressed", on ? "false" : "true");
    btnIdle.setAttribute("aria-pressed", "false");
    mode = on ? "" : "cap";
    render();
  });

  btnIdle.addEventListener("click", ()=>{
    const on = btnIdle.getAttribute("aria-pressed")==="true";
    btnIdle.setAttribute("aria-pressed", on ? "false" : "true");
    btnCap.setAttribute("aria-pressed", "false");
    mode = on ? "" : "idle";
    render();
  });

  // inputs básicos
  ["qClient","selRes","dStart","dEnd"].forEach(id=>{
    document.getElementById(id).addEventListener("input", ()=>render());
    document.getElementById(id).addEventListener("change", ()=>render());
  });

  // limpar
  document.getElementById("btnClear").addEventListener("click", ()=>{
    selectedCodes.clear();
    document.querySelectorAll(".chipBtn").forEach(b=>b.setAttribute("aria-pressed","false"));
    document.getElementById("qClient").value="";
    document.getElementById("selRes").value="";
    document.getElementById("dStart").value="";
    document.getElementById("dEnd").value="";
    mode="";
    document.getElementById("btnCap").setAttribute("aria-pressed","false");
    document.getElementById("btnIdle").setAttribute("aria-pressed","false");
    render();
  });

  // reload
  document.getElementById("btnReload").addEventListener("click", ()=>load());
}

/* ===================== BOOT ===================== */
wire();
load();
</script>
</body>
</html>
