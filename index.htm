<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel PMO - Gestão de Capacidade (Folha)</title>
  <style>
    :root{
      --bg:#0b1220;
      --muted:#93a4c7;
      --text:#e8efff;
      --line:rgba(255,255,255,.10);
      --card: rgba(15,26,48,.70);

      /* Chips (recursos) */
      --do:#60a5fa;
      --ge:#34d399;
      --jc:#fbbf24;
      --al:#fb7185;

      /* Faixas de turno (visíveis) */
      --mRow: rgba(167,139,250,.24);  /* Manhã */
      --tRow: rgba(56,189,248,.20);   /* Tarde */
      --mLeft: rgba(167,139,250,.46);
      --tLeft: rgba(56,189,248,.40);

      /* Larguras das colunas fixas */
      --wClient: 220px;
      --wShift: 110px;

      /* Offsets sticky calculados */
      --leftClient: 0px;
      --leftShift: var(--wClient);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(900px 500px at 20% 0%, #14264a 0%, var(--bg) 60%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    header{
      padding:18px 18px 10px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background:rgba(11,18,32,.72);
      z-index:50;
    }
    .wrap{max-width:1500px; margin:0 auto; padding:0 18px;}
    .title{display:flex; align-items:center; justify-content:space-between; gap:16px;}
    h1{margin:0; font-size:16px; font-weight:700; letter-spacing:.2px;}
    .sub{margin:6px 0 0; color:var(--muted); font-size:12px;}

    .toolbar{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1.4fr 1fr 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    .field label{display:block; font-size:11px; color:var(--muted); margin:0 0 6px;}
    .field input, .field select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(15,26,48,.70);
      color:var(--text);
      outline:none;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(45,212,191,.22), rgba(15,26,48,.65));
      color:var(--text);
      cursor:pointer;
      user-select:none;
      font-weight:650;
    }
    .btn:active{transform:translateY(1px)}

    .legend{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:rgba(21,38,74,.85);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--text)
    }
    .dot{width:10px; height:10px; border-radius:50%}

    .cards{
      padding:14px 0;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 12px 26px rgba(0,0,0,.28);
      min-height:80px;
    }
    .kpi{font-size:12px; color:var(--muted)}
    .val{margin-top:6px; font-size:18px; font-weight:800}

    main{padding:0 18px 22px}
    .gridcard{
      max-width:1500px; margin:0 auto;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 16px 34px rgba(0,0,0,.30);
    }
    .gridhead{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }
    .gridhead .hint{color:var(--muted); font-size:12px}

    .tablewrap{overflow:auto; max-height:72vh}

    table{
      border-collapse:separate;
      border-spacing:0;
      width:max-content;
      min-width:100%;
    }

    thead th{
      position:sticky; top:0; z-index:10;
      background:rgba(11,18,32,.95);
      border-bottom:1px solid var(--line);
      font-size:11px;
      color:var(--muted);
      padding:10px 8px;
      white-space:nowrap;
    }

    /* Sticky headers: Cliente | Turno */
    thead th.col-client{
      position:sticky; left:var(--leftClient);
      z-index:40;
      background:rgba(11,18,32,.98);
      border-right:1px solid rgba(255,255,255,.06);
      min-width:var(--wClient);
      max-width:var(--wClient);
    }
    thead th.col-shift{
      position:sticky; left:var(--leftShift);
      z-index:40;
      background:rgba(11,18,32,.98);
      border-right:1px solid rgba(255,255,255,.06);
      min-width:var(--wShift);
      max-width:var(--wShift);
      text-align:center;
    }

    tbody td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:8px 8px;
      font-size:12px;
      white-space:nowrap;
    }

    /* Sticky body cells */
    tbody td.col-client, tbody td.col-shift{
      position:sticky;
      z-index:25;
      background:rgba(11,18,32,.92);
      border-right:1px solid rgba(255,255,255,.06);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    tbody td.col-client{
      left:var(--leftClient);
      min-width:var(--wClient);
      max-width:var(--wClient);
      font-weight:950;
      vertical-align:middle;
    }
    tbody td.col-shift{
      left:var(--leftShift);
      min-width:var(--wShift);
      max-width:var(--wShift);
      text-align:center;
      font-weight:950;
      letter-spacing:.3px;
    }

    /* Faixa visual por turno (linha inteira) */
    tr.shift-m td{ background-color: var(--mRow); }
    tr.shift-t td{ background-color: var(--tRow); }

    /* Mantém contraste nas colunas sticky + adiciona faixa por turno */
    tr.shift-m td.col-client, tr.shift-m td.col-shift{
      background: linear-gradient(90deg, var(--mLeft), rgba(11,18,32,.92) 70%);
    }
    tr.shift-t td.col-client, tr.shift-t td.col-shift{
      background: linear-gradient(90deg, var(--tLeft), rgba(11,18,32,.92) 70%);
    }

    /* Agrupamento visual: célula do cliente ocupa 2 linhas (rowspan) */
    td.col-client[rowspan="2"]{
      border-bottom:1px solid rgba(255,255,255,.10);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:38px;
      height:26px;
      padding:0 8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(21,38,74,.75);
      font-weight:900;
      color:var(--text);
    }
    .empty{opacity:.25}

    .today{
      outline:2px solid rgba(45,212,191,.85);
      box-shadow: inset 0 0 0 1px rgba(45,212,191,.28);
    }

    .foot{
      padding:10px 14px;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-size:12px;
    }

    @media (max-width:1100px){
      .toolbar{grid-template-columns: 1fr 1fr;}
      .cards{grid-template-columns: 1fr 1fr;}
      :root{
        --wClient: 190px;
        --wShift: 100px;
      }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="title">
      <div>
        <h1>Painel PMO — Gestão de Capacidade (Folha)</h1>
        <div class="sub">Fonte: Google Sheets publicado na Web (CSV). Cliente agrupado (rowspan) com 2 linhas: Manhã e Tarde. Sem coluna Projeto.</div>
      </div>
      <button class="btn" id="btnReload">Recarregar dados</button>
    </div>

    <div class="toolbar">
      <div class="field">
        <label>Busca (cliente)</label>
        <input id="q" placeholder="Ex.: HS MATEUS, ABBR, MEDILAR..." />
      </div>
      <div class="field">
        <label>Filtro por recurso</label>
        <select id="resource">
          <option value="">Todos</option>
          <option value="DO">DO</option>
          <option value="GE">GE</option>
          <option value="JC">JC</option>
          <option value="AL">AL</option>
        </select>
      </div>
      <div class="field">
        <label>Data início (dd/mm)</label>
        <input id="start" placeholder="Ex.: 24/01" />
      </div>
      <div class="field">
        <label>Data fim (dd/mm)</label>
        <input id="end" placeholder="Ex.: 29/04" />
      </div>
    </div>

    <div class="legend" id="legend"></div>

    <div class="cards">
      <div class="card">
        <div class="kpi">Linhas (turnos)</div>
        <div class="val" id="kpiRows">—</div>
      </div>
      <div class="card">
        <div class="kpi">Janela de datas (colunas)</div>
        <div class="val" id="kpiCols">—</div>
      </div>
      <div class="card">
        <div class="kpi">Células preenchidas</div>
        <div class="val" id="kpiFilled">—</div>
      </div>
      <div class="card">
        <div class="kpi">Sinalização “Hoje”</div>
        <div class="val" id="kpiToday">—</div>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="gridcard">
    <div class="gridhead">
      <div style="font-weight:900">Grade de Alocação</div>
      <div class="hint" id="status">Status: aguardando carga…</div>
    </div>
    <div class="tablewrap">
      <table id="tbl">
        <thead><tr id="theadRow"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="foot">
      <div>Governança: SSOT operacional; ajuste de critérios deve ser feito na planilha (baseline).</div>
      <div id="footRight">—</div>
    </div>
  </div>
</main>

<script>
/* ============================================================
   CONFIG — PLANILHA PUBLICADA NA WEB (SEU LINK pubhtml)
============================================================ */
const PUBLISHED_BASE =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSgqs7bjsPeaojEQG7buOiixxv7tg1F6jt2wogHKI7O2AvjS-_aq6o7knAO5HgrUd5jZ1iWge4ZgMHM/pub";

const SHEET_GID = "0"; // ajuste conforme a aba publicada

const ENDPOINT_PUBLISHED_CSV = (gid) =>
  `${PUBLISHED_BASE}?output=csv&single=true&gid=${encodeURIComponent(gid)}`;

/* ============================================================
   HELPERS
============================================================ */
const $ = (id) => document.getElementById(id);

function getCSS(varName){
  return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
}
const COLOR = {
  "DO": getCSS("--do"),
  "GE": getCSS("--ge"),
  "JC": getCSS("--jc"),
  "AL": getCSS("--al"),
  "M":  "rgba(167,139,250,.95)",
  "T":  "rgba(56,189,248,.90)"
};

function pill(label, key){
  const el = document.createElement("div");
  el.className = "pill";
  const dot = document.createElement("span");
  dot.className = "dot";
  dot.style.background = COLOR[key] || "#cbd5e1";
  const txt = document.createElement("span");
  txt.textContent = label;
  el.appendChild(dot); el.appendChild(txt);
  return el;
}

function buildLegend(){
  const lg = $("legend");
  lg.innerHTML = "";
  lg.appendChild(pill("DO", "DO"));
  lg.appendChild(pill("GE", "GE"));
  lg.appendChild(pill("JC", "JC"));
  lg.appendChild(pill("AL", "AL"));
  lg.appendChild(pill("Faixa Manhã", "M"));
  lg.appendChild(pill("Faixa Tarde", "T"));
}

function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQ = false;
  for (let i=0;i<text.length;i++){
    const ch = text[i], nx = text[i+1];
    if (ch === '"' && nx === '"'){ cur += '"'; i++; continue; }
    if (ch === '"'){ inQ = !inQ; continue; }
    if (ch === ',' && !inQ){ row.push(cur); cur=""; continue; }
    if ((ch === '\n' || ch === '\r') && !inQ){
      if (cur.length || row.length){ row.push(cur); rows.push(row); }
      row=[]; cur="";
      continue;
    }
    cur += ch;
  }
  if (cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows.map(r => r.map(c => (c ?? "").trim()));
}

function normalizeDateLabel(s){
  if (!s) return "";
  const m = s.match(/^(\d{1,2})\/(\d{1,2})(?:\/\d{2,4})?$/);
  if (!m) return s;
  const dd = String(m[1]).padStart(2,"0");
  const mm = String(m[2]).padStart(2,"0");
  return `${dd}/${mm}`;
}

function todayLabel(){
  const d = new Date();
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  return `${dd}/${mm}`;
}

function inWindow(label, start, end){
  if (!start && !end) return true;
  const idx = (x)=> {
    const m = x.match(/^(\d{2})\/(\d{2})$/);
    if (!m) return -1;
    return parseInt(m[2],10)*100 + parseInt(m[1],10);
  };
  const v = idx(label);
  const a = start ? idx(start) : -Infinity;
  const b = end ? idx(end) : Infinity;
  return (v >= a && v <= b);
}

function chip(value){
  const sp = document.createElement("span");
  sp.className = "chip" + (!value ? " empty" : "");
  sp.textContent = value || "—";
  if (COLOR[value]){
    sp.style.color = "#0b1220";
    sp.style.background = COLOR[value];
    sp.style.borderColor = "rgba(255,255,255,.14)";
  }
  return sp;
}

function normalizeShift(s){
  const v = (s || "").toUpperCase().trim();
  if (v === "M" || v === "MANHÃ" || v === "MANHA") return "M";
  if (v === "T" || v === "TARDE") return "T";
  return "";
}
function shiftLabel(s){
  return s === "M" ? "MANHÃ" : (s === "T" ? "TARDE" : "—");
}

/* ============================================================
   DATA LOAD
============================================================ */
async function fetchCSV(){
  const url = ENDPOINT_PUBLISHED_CSV(SHEET_GID);
  const res = await fetch(url, { cache:"no-store" });
  if (!res.ok){
    throw new Error(`Falha ao carregar CSV publicado. HTTP ${res.status}. URL: ${url}`);
  }
  const text = await res.text();
  if (!text || text.length < 10){
    throw new Error(`CSV vazio. Verifique o gid (${SHEET_GID}) e se a aba está publicada no documento.`);
  }
  return text;
}

/* ============================================================
   Normalização para agrupamento (cliente -> 2 linhas M/T)
   Espera layout base: "CLIENTE • M" e linha "T" isolada (ou "CLIENTE • T")
============================================================ */
function getClientAndShift(row, dateIdxStart, lastClient){
  const firstNonEmpty = row.findIndex(c => c && c !== "");
  if (firstNonEmpty === -1) return null;

  const cellA = (row[firstNonEmpty] || "").trim();
  const cellB = (row[firstNonEmpty+1] || "").trim();

  let client = cellA;
  let shift = "";

  if (cellA.includes("•")){
    const parts = cellA.split("•").map(x=>x.trim());
    client = parts[0] || cellA;
    shift = normalizeShift(parts[1] || "");
  } else {
    shift = normalizeShift(cellB);
    const solo = normalizeShift(cellA);
    if (solo && lastClient){
      client = lastClient;
      shift = solo;
    }
  }

  if (!shift){
    // tenta inferir se célula A for "T" ou "M"
    const solo = normalizeShift(cellA);
    if (solo && lastClient){
      client = lastClient;
      shift = solo;
    }
  }

  client = client || lastClient || "—";
  const alloc = row.slice(dateIdxStart).map(c => (c || "").trim());

  return { client, shift, alloc };
}

async function load(){
  $("status").textContent = "Status: carregando…";

  const csv = await fetchCSV();
  const data = parseCSV(csv);
  const cleaned = data.filter(r => r.some(c => c && c !== ""));

  if (cleaned.length < 3){
    $("status").textContent = "Status: CSV sem conteúdo útil (estrutura insuficiente).";
    return;
  }

  const dowRow  = cleaned[0];
  const dateRow = cleaned[1];

  const dateIdxStart = dateRow.findIndex(c => /^\d{1,2}\/\d{1,2}/.test(c));
  if (dateIdxStart === -1){
    $("status").textContent = "Status: não localizei coluna inicial de datas (dd/mm).";
    return;
  }

  const rawRows = cleaned.slice(2);
  const dates = dateRow.slice(dateIdxStart).map(normalizeDateLabel);
  const dows  = dowRow.slice(dateIdxStart).map(c => c || "");

  const q = $("q").value.trim().toLowerCase();
  const rFilter = $("resource").value.trim();
  const start = normalizeDateLabel($("start").value.trim());
  const end   = normalizeDateLabel($("end").value.trim());

  const dateMask = dates.map(d => inWindow(d, start, end));
  const filteredDates = dates.filter((_,i)=>dateMask[i]);
  const filteredDows  = dows.filter((_,i)=>dateMask[i]);

  // HEADER: Cliente | Turno | Datas...
  const thead = $("theadRow");
  thead.innerHTML = "";

  const thClient = document.createElement("th");
  thClient.textContent = "Cliente";
  thClient.className = "col-client";
  thead.appendChild(thClient);

  const thShift = document.createElement("th");
  thShift.textContent = "Turno";
  thShift.className = "col-shift";
  thead.appendChild(thShift);

  filteredDates.forEach((d, i) => {
    const th = document.createElement("th");
    th.innerHTML = `${filteredDows[i] ? filteredDows[i] + "<br/>" : ""}${d}`;
    thead.appendChild(th);
  });

  // 1) Normaliza linhas em objetos
  let lastClient = "";
  const items = [];
  for (const r of rawRows){
    const parsed = getClientAndShift(r, dateIdxStart, lastClient);
    if (!parsed) continue;
    if (parsed.client && parsed.client !== "—") lastClient = parsed.client;
    items.push(parsed);
  }

  // 2) Agrupa por cliente preservando sequência, com 2 linhas M/T
  const groups = [];
  const map = new Map();
  for (const it of items){
    const key = it.client;
    if (!map.has(key)){
      const g = { client: key, M: null, T: null };
      map.set(key, g);
      groups.push(g);
    }
    const g = map.get(key);
    if (it.shift === "M") g.M = it;
    if (it.shift === "T") g.T = it;
  }

  // 3) Render com rowspan: cliente aparece uma vez e ocupa 2 linhas (M e T)
  const tbody = $("tbody");
  tbody.innerHTML = "";

  const today = todayLabel();
  let lines = 0, filled = 0;

  function renderShiftRow(shiftKey, it, clientCell, isFirstRow){
    const tr = document.createElement("tr");
    tr.classList.add(shiftKey === "M" ? "shift-m" : "shift-t");

    // cliente com rowspan apenas na primeira linha (M)
    if (isFirstRow){
      tr.appendChild(clientCell);
    }

    // turno
    const tdS = document.createElement("td");
    tdS.className = "col-shift";
    tdS.textContent = shiftLabel(shiftKey);
    tr.appendChild(tdS);

    // alocações
    const alloc = (it && it.alloc) ? it.alloc : [];
    const allocWin = alloc.filter((_,i)=>dateMask[i]);

    allocWin.forEach((v, idx) => {
      const td = document.createElement("td");
      td.appendChild(chip(v));

      const d = filteredDates[idx];
      if (d === today) td.classList.add("today");

      if (v) filled++;
      tr.appendChild(td);
    });

    // se não houver aloc, ainda renderiza colunas vazias
    if (allocWin.length === 0){
      for (let i=0;i<filteredDates.length;i++){
        const td = document.createElement("td");
        td.appendChild(chip(""));
        const d = filteredDates[i];
        if (d === today) td.classList.add("today");
        tr.appendChild(td);
      }
    }

    tbody.appendChild(tr);
    lines++;
  }

  for (const g of groups){
    // filtro por cliente
    if (q && !g.client.toLowerCase().includes(q)) continue;

    // filtro por recurso: precisa existir em M ou T
    if (rFilter){
      const hasInM = g.M && g.M.alloc && g.M.alloc.some(v => v === rFilter);
      const hasInT = g.T && g.T.alloc && g.T.alloc.some(v => v === rFilter);
      if (!hasInM && !hasInT) continue;
    }

    // cliente cell (rowspan 2)
    const tdC = document.createElement("td");
    tdC.className = "col-client";
    tdC.textContent = g.client || "—";
    tdC.rowSpan = 2;

    // Render M e T sempre, mantendo duas linhas
    renderShiftRow("M", g.M, tdC, true);
    renderShiftRow("T", g.T, null, false);
  }

  $("kpiRows").textContent = lines.toLocaleString("pt-BR");
  $("kpiCols").textContent = filteredDates.length.toLocaleString("pt-BR");
  $("kpiFilled").textContent = filled.toLocaleString("pt-BR");
  $("kpiToday").textContent = today;

  $("status").textContent = "Status: carregado com sucesso (SSOT operacional).";
  $("footRight").textContent = `Atualizado em ${new Date().toLocaleString("pt-BR")} • gid=${SHEET_GID}`;
}

function wire(){
  buildLegend();

  const rerun = () => load().catch(err => {
    console.error(err);
    $("status").textContent = "Status: erro na carga. Validar CSV publicado (gid/endpoint).";
    $("footRight").textContent = err.message;
  });

  ["q","resource","start","end"].forEach(id => {
    $(id).addEventListener("input", rerun);
    $(id).addEventListener("change", rerun);
  });
  $("btnReload").addEventListener("click", rerun);

  rerun();
}
wire();
</script>
</body>
</html>
