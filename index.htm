<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel PMO - Gestão de Capacidade (Folha)</title>
  <style>
    :root{
      --bg:#0b1220;
      --muted:#93a4c7;
      --text:#e8efff;
      --line:rgba(255,255,255,.10);
      --card: rgba(15,26,48,.70);

      --do:#60a5fa;
      --ge:#34d399;
      --jc:#fbbf24;
      --al:#fb7185;

      --mRow: rgba(167,139,250,.24);
      --tRow: rgba(56,189,248,.20);

      --wClient: 220px;
      --wShift: 110px;

      --hdrH: 0px; /* calculado via JS */
      --rowH: 42px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(900px 500px at 20% 0%, #14264a 0%, var(--bg) 60%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow:hidden; /* o scroll é dentro dos containers */
    }

    /* ================= HEADER (com colapsar/expandir filtros) ================= */
    header{
      padding:16px 18px 12px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background:rgba(11,18,32,.72);
      z-index:50;
    }
    header.collapsed .toolbar,
    header.collapsed .legendWrap,
    header.collapsed .cards{
      display:none !important;
    }

    .wrap{max-width:1500px; margin:0 auto; padding:0 18px;}
    .title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
    }
    .titleLeft{display:flex; flex-direction:column; gap:6px;}
    h1{margin:0; font-size:16px; font-weight:800; letter-spacing:.2px;}
    .sub{margin:0; color:var(--muted); font-size:12px; line-height:1.25;}
    .titleRight{display:flex; align-items:center; gap:10px;}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(45,212,191,.22), rgba(15,26,48,.65));
      color:var(--text);
      cursor:pointer;
      user-select:none;
      font-weight:700;
      white-space:nowrap;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{ background:rgba(15,26,48,.70); }

    /* Botão maximizar/minimizar filtros */
    .iconBtn{
      width:46px;
      height:42px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(15,26,48,.70);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      position:relative;
    }
    .iconBtn:hover{
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
    }
    .iconBtn:active{ transform: translateY(1px); }
    .funnel{width:18px; height:18px; position:relative;}
    .funnel:before, .funnel:after{
      content:"";
      position:absolute;
      left:0; right:0;
      margin:auto;
      border-radius:2px;
      background:rgba(232,239,255,.92);
    }
    .funnel:before{
      width:18px; height:3px; top:1px;
      box-shadow: 0 5px 0 rgba(232,239,255,.92),
                  0 10px 0 rgba(232,239,255,.92);
    }
    .funnel:after{ width:10px; height:3px; top:14px; }

    .iconBtn[data-tip]:hover::after{
      content: attr(data-tip);
      position:absolute;
      right:0;
      top:calc(100% + 8px);
      white-space:nowrap;
      background:rgba(0,0,0,.82);
      border:1px solid rgba(255,255,255,.18);
      color:var(--text);
      padding:6px 10px;
      border-radius:10px;
      font-size:12px;
      z-index:999;
      pointer-events:none;
    }

    .toolbar{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1.4fr 1fr 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    .field label{display:block; font-size:11px; color:var(--muted); margin:0 0 6px;}
    .field input, .field select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(15,26,48,.70);
      color:var(--text);
      outline:none;
    }

    .legendWrap{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .legend{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .chipBtn{
      display:inline-flex; align-items:center; gap:8px;
      background:rgba(21,38,74,.85);
      border:1px solid var(--line);
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      color:var(--text);
      cursor:pointer;
      user-select:none;
      position:relative;
      transition: opacity .15s ease, border-color .15s ease, transform .05s ease, box-shadow .15s ease;
    }
    .chipBtn:hover{ border-color: rgba(255,255,255,.25); box-shadow:0 10px 20px rgba(0,0,0,.25); }
    .chipBtn:active{ transform: translateY(1px); }
    .chipBtn .dot{width:10px; height:10px; border-radius:50%}
    .chipBtn .code{font-weight:900; letter-spacing:.2px}
    .chipBtn .caret{display:none; font-weight:900; margin-left:2px}
    .chipBtn[aria-pressed="true"]{
      border-color: rgba(255,255,255,.38);
      box-shadow: 0 12px 22px rgba(0,0,0,.32);
    }
    .chipBtn[aria-pressed="true"] .caret{display:inline}

    .chipBtn[data-tip]:hover::after{
      content: attr(data-tip);
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      top:calc(100% + 8px);
      white-space:nowrap;
      background:rgba(0,0,0,.82);
      border:1px solid rgba(255,255,255,.18);
      color:var(--text);
      padding:6px 10px;
      border-radius:10px;
      font-size:12px;
      z-index:999;
      pointer-events:none;
    }

    .hintline{
      color:var(--muted);
      font-size:11px;
      opacity:.9;
    }

    .cards{
      padding:12px 0 6px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 12px 26px rgba(0,0,0,.28);
      min-height:72px;
    }
    .kpi{font-size:12px; color:var(--muted)}
    .val{margin-top:6px; font-size:18px; font-weight:800}

    /* ================= MAIN ================= */
    main{
      height: calc(100vh - var(--hdrH));
      padding:0 18px 0;
      overflow:hidden;
    }

    .gridcard{
      max-width:1500px;
      height:100%;
      margin:0 auto;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 16px 34px rgba(0,0,0,.30);
      display:flex;
      flex-direction:column;
    }
    .gridhead{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      flex:0 0 auto;
    }
    .gridhead .hint{color:var(--muted); font-size:12px}

    /* ================= GRID (colunas congeladas + scroll horizontal apenas no bloco de datas) ================= */
    .gridBody{
      display:flex;
      flex:1 1 auto;
      min-height:0; /* necessário para flex scroll */
    }

    /* Esquerda: CLIENTE + TURNO (congelado) */
    .leftPane{
      width: calc(var(--wClient) + var(--wShift));
      border-right:1px solid rgba(255,255,255,.08);
      background:rgba(11,18,32,.55);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .leftScroll{
      overflow-y:auto;         /* scroll vertical */
      overflow-x:hidden;
      flex:1 1 auto;
      min-height:0;
    }
    /* esconde scrollbar da esquerda (fica “congelado” visualmente) */
    .leftScroll::-webkit-scrollbar{ width:0px; height:0px; }
    .leftScroll{ scrollbar-width:none; }

    /* Direita: DATAS + ALOCAÇÕES (scroll horizontal controlado por barra fixa) */
    .rightPaneWrap{
      flex:1 1 auto;
      min-width:0;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .rightScroll{
      overflow-y:auto;      /* scroll vertical */
      overflow-x:hidden;    /* horizontal via barra fixa */
      flex:1 1 auto;
      min-height:0;
    }

    /* Tabelas */
    table{
      border-collapse:separate;
      border-spacing:0;
      width:max-content;
    }

    /* Cabeçalhos */
    .leftTable thead th,
    .rightTable thead th{
      position:sticky; top:0;
      z-index:10;
      background:rgba(11,18,32,.95);
      border-bottom:1px solid var(--line);
      font-size:11px;
      color:var(--muted);
      padding:10px 8px;
      white-space:nowrap;
    }
    .leftTable thead th{
      z-index:15;
    }

    /* Células */
    .leftTable tbody td,
    .rightTable tbody td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:8px 8px;
      font-size:12px;
      white-space:nowrap;
      height:var(--rowH);
    }

    /* Linhas (faixas por turno) */
    .row-m td{ background-color: var(--mRow); }
    .row-t td{ background-color: var(--tRow); }

    /* Lado esquerdo: colunas fixas */
    .col-client{
      min-width:var(--wClient);
      max-width:var(--wClient);
      font-weight:950;
      padding:0 !important;
    }
    .col-shift{
      min-width:var(--wShift);
      max-width:var(--wShift);
      text-align:center;
      font-weight:950;
      letter-spacing:.3px;
    }

    .clientBox{
      height:100%;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px 10px;
    }
    .clientBadge{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(148,163,184,.18), rgba(21,38,74,.38));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      padding:14px 10px;
      text-align:center;
      font-weight:950;
      letter-spacing:.6px;
      text-transform:uppercase;
    }

    /* Chips dentro da grade */
    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:38px;
      height:26px;
      padding:0 8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(21,38,74,.75);
      font-weight:900;
      color:var(--text);
    }
    .empty{opacity:.25}
    .today{
      outline:2px solid rgba(45,212,191,.85);
      box-shadow: inset 0 0 0 1px rgba(45,212,191,.28);
    }

    /* ===== Barra horizontal SEMPRE visível e SOMENTE do grid de datas ===== */
    .hscrollBar{
      height:14px;
      overflow-x:auto;
      overflow-y:hidden;
      background:rgba(11,18,32,.75);
      border-top:1px solid rgba(255,255,255,.08);
      flex:0 0 auto;
    }
    .hscrollBar::-webkit-scrollbar{ height:14px; }
    .hscrollBar::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.22);
      border-radius:999px;
      border:3px solid rgba(11,18,32,.75);
    }
    .hscrollInner{ height:1px; }

    .foot{
      padding:10px 14px;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-size:12px;
      flex:0 0 auto;
    }

    @media (max-width:1100px){
      .toolbar{grid-template-columns: 1fr 1fr;}
      .cards{grid-template-columns: 1fr 1fr;}
      :root{ --wClient: 190px; --wShift: 100px; }
    }
  </style>
</head>

<body>
<header id="hdr">
  <div class="wrap">
    <div class="title">
      <div class="titleLeft">
        <h1>Painel PMO — Gestão de Capacidade (Folha)</h1>
        <div class="sub">
          Colunas congeladas: Cliente + Turno. Barra horizontal sempre visível e exclusiva do grid de datas/alocações.
          Ícone (funil) maximiza/minimiza filtros para expandir a grade.
        </div>
      </div>

      <div class="titleRight">
        <button class="iconBtn" id="btnToggleFilters" data-tip="Maximizar/Minimizar filtros">
          <span class="funnel"></span>
        </button>
        <button class="btn" id="btnReload">Recarregar dados</button>
      </div>
    </div>

    <div class="toolbar">
      <div class="field">
        <label>Busca (cliente)</label>
        <input id="q" placeholder="Ex.: HS MATEUS, ABBR, MEDILAR..." />
      </div>
      <div class="field">
        <label>Filtro por recurso (dropdown)</label>
        <select id="resource">
          <option value="">Todos</option>
          <option value="DO">DO</option>
          <option value="GE">GE</option>
          <option value="JC">JC</option>
          <option value="AL">AL</option>
        </select>
      </div>
      <div class="field">
        <label>Data início (dd/mm)</label>
        <input id="start" placeholder="Ex.: 24/01" />
      </div>
      <div class="field">
        <label>Data fim (dd/mm)</label>
        <input id="end" placeholder="Ex.: 29/04" />
      </div>
    </div>

    <div class="legendWrap">
      <div class="legend" id="legend"></div>
      <button class="btn secondary" id="btnClear" style="padding:6px 10px; border-radius:999px;">Limpar seleção</button>
      <span class="hintline">Hover chips: DO=Dôra, GE=Geovana, JC=João Custódio, AL=Aline</span>
    </div>

    <div class="cards" id="cardsBlock">
      <div class="card">
        <div class="kpi">Linhas (turnos)</div>
        <div class="val" id="kpiRows">—</div>
      </div>
      <div class="card">
        <div class="kpi">Janela de datas (colunas)</div>
        <div class="val" id="kpiCols">—</div>
      </div>
      <div class="card">
        <div class="kpi">Células preenchidas</div>
        <div class="val" id="kpiFilled">—</div>
      </div>
      <div class="card">
        <div class="kpi">Sinalização “Hoje”</div>
        <div class="val" id="kpiToday">—</div>
      </div>
    </div>
  </div>
</header>

<main id="main">
  <div class="gridcard">
    <div class="gridhead">
      <div style="font-weight:900">Grade de Alocação</div>
      <div class="hint" id="status">Status: aguardando carga…</div>
    </div>

    <!-- GRID SPLIT: esquerda (congelado) + direita (datas) -->
    <div class="gridBody">
      <!-- LEFT (Cliente + Turno) -->
      <div class="leftPane">
        <div class="leftScroll" id="leftScroll">
          <table class="leftTable" id="leftTable">
            <thead>
              <tr>
                <th style="min-width:var(--wClient);max-width:var(--wClient);">Cliente</th>
                <th style="min-width:var(--wShift);max-width:var(--wShift);text-align:center;">Turno</th>
              </tr>
            </thead>
            <tbody id="leftBody"></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT (Datas + Alocações) -->
      <div class="rightPaneWrap">
        <div class="rightScroll" id="rightScroll">
          <table class="rightTable" id="rightTable">
            <thead>
              <tr id="rightHead"></tr>
            </thead>
            <tbody id="rightBody"></tbody>
          </table>
        </div>

        <!-- Barra horizontal SEMPRE visível (somente datas/alocações) -->
        <div class="hscrollBar" id="hscrollBar">
          <div class="hscrollInner" id="hscrollInner"></div>
        </div>
      </div>
    </div>

    <div class="foot">
      <div>Governança: SSOT operacional; ajuste de critérios deve ser feito na planilha (baseline).</div>
      <div id="footRight">—</div>
    </div>
  </div>
</main>

<script>
/* ===== CONFIG ===== */
const PUBLISHED_BASE =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSgqs7bjsPeaojEQG7buOiixxv7tg1F6jt2wogHKI7O2AvjS-_aq6o7knAO5HgrUd5jZ1iWge4ZgMHM/pub";
const SHEET_GID = "0";
const ENDPOINT_PUBLISHED_CSV = (gid) => `${PUBLISHED_BASE}?output=csv&single=true&gid=${encodeURIComponent(gid)}`;

const RESOURCE_NAMES = { "DO":"Dôra", "GE":"Geovana", "JC":"João Custódio", "AL":"Aline" };

const state = { selected: new Set(), cache: null };
const $ = (id) => document.getElementById(id);

function getCSS(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }
const COLOR = { "DO":getCSS("--do"), "GE":getCSS("--ge"), "JC":getCSS("--jc"), "AL":getCSS("--al") };

/* ===== HEADER expand/collapse ===== */
function syncHeaderHeight(){
  const h = Math.ceil($("hdr").getBoundingClientRect().height);
  document.documentElement.style.setProperty("--hdrH", h + "px");
}
function toggleFilters(){
  $("hdr").classList.toggle("collapsed");
  syncHeaderHeight();
}
$("btnToggleFilters").addEventListener("click", toggleFilters);
window.addEventListener("resize", () => { syncHeaderHeight(); syncHScrollWidth(); });

/* ===== Chips ===== */
function buildLegend(){
  const lg = $("legend");
  lg.innerHTML = "";
  ["DO","GE","JC","AL"].forEach(code => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "chipBtn";
    b.setAttribute("data-code", code);
    b.setAttribute("aria-pressed", "false");
    b.setAttribute("data-tip", `${code} = ${RESOURCE_NAMES[code]}`);

    const dot = document.createElement("span");
    dot.className = "dot";
    dot.style.background = COLOR[code];

    const codeEl = document.createElement("span");
    codeEl.className = "code";
    codeEl.textContent = code;

    const caret = document.createElement("span");
    caret.className = "caret";
    caret.textContent = "✓";

    b.appendChild(dot); b.appendChild(codeEl); b.appendChild(caret);

    b.addEventListener("click", (ev) => {
      const multi = ev.ctrlKey || ev.metaKey;
      if (multi){
        if (state.selected.has(code)) state.selected.delete(code);
        else state.selected.add(code);
      } else {
        const onlyThisAlready = state.selected.size === 1 && state.selected.has(code);
        state.selected.clear();
        if (!onlyThisAlready) state.selected.add(code);
      }
      $("resource").value = "";
      syncLegendUI();
      rerender();
    });

    lg.appendChild(b);
  });
  syncLegendUI();
}
function syncLegendUI(){
  const any = state.selected.size > 0;
  document.querySelectorAll(".chipBtn[data-code]").forEach(btn => {
    const code = btn.getAttribute("data-code");
    const on = state.selected.has(code);
    btn.setAttribute("aria-pressed", on ? "true" : "false");
    btn.style.opacity = (!any || on) ? "1" : ".55";
  });
}
$("btnClear").addEventListener("click", () => {
  state.selected.clear();
  $("resource").value = "";
  syncLegendUI();
  rerender();
});

/* ===== Active filter ===== */
function getActiveCodes(){
  const dd = $("resource").value.trim();
  if (dd) return new Set([dd]);
  return new Set(state.selected);
}

/* ===== CSV ===== */
function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQ = false;
  for (let i=0;i<text.length;i++){
    const ch = text[i], nx = text[i+1];
    if (ch === '"' && nx === '"'){ cur += '"'; i++; continue; }
    if (ch === '"'){ inQ = !inQ; continue; }
    if (ch === ',' && !inQ){ row.push(cur); cur=""; continue; }
    if ((ch === '\n' || ch === '\r') && !inQ){
      if (cur.length || row.length){ row.push(cur); rows.push(row); }
      row=[]; cur="";
      continue;
    }
    cur += ch;
  }
  if (cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows.map(r => r.map(c => (c ?? "").trim()));
}
async function fetchCSV(){
  const url = ENDPOINT_PUBLISHED_CSV(SHEET_GID);
  const res = await fetch(url, { cache:"no-store" });
  if (!res.ok) throw new Error(`Falha ao carregar CSV publicado. HTTP ${res.status}. URL: ${url}`);
  const text = await res.text();
  if (!text || text.length < 10) throw new Error(`CSV vazio. Verifique gid (${SHEET_GID}).`);
  return text;
}
function normalizeDateLabel(s){
  if (!s) return "";
  const m = s.match(/^(\d{1,2})\/(\d{1,2})(?:\/\d{2,4})?$/);
  if (!m) return s;
  return `${String(m[1]).padStart(2,"0")}/${String(m[2]).padStart(2,"0")}`;
}
function todayLabel(){
  const d = new Date();
  return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}`;
}
function inWindow(label, start, end){
  if (!start && !end) return true;
  const idx = (x)=> {
    const m = x.match(/^(\d{2})\/(\d{2})$/);
    if (!m) return -1;
    return parseInt(m[2],10)*100 + parseInt(m[1],10);
  };
  const v = idx(label);
  const a = start ? idx(start) : -Infinity;
  const b = end ? idx(end) : Infinity;
  return (v >= a && v <= b);
}
function chip(value){
  const v = (value || "").trim().toUpperCase();
  const sp = document.createElement("span");
  sp.className = "chip" + (!v ? " empty" : "");
  sp.textContent = v || "—";
  if (v && RESOURCE_NAMES[v]) sp.title = `${v} = ${RESOURCE_NAMES[v]}`;

  const colors = { DO:getCSS("--do"), GE:getCSS("--ge"), JC:getCSS("--jc"), AL:getCSS("--al") };
  if (colors[v]){
    sp.style.color = "#0b1220";
    sp.style.background = colors[v];
    sp.style.borderColor = "rgba(255,255,255,.14)";
  }
  return sp;
}
function normalizeShift(s){
  const v = (s || "").toUpperCase().trim();
  if (v === "M" || v === "MANHÃ" || v === "MANHA") return "M";
  if (v === "T" || v === "TARDE") return "T";
  return "";
}
function shiftLabel(s){ return s === "M" ? "MANHÃ" : "TARDE"; }

/* ===== Data mapping (cliente/turno) ===== */
function getClientAndShift(row, dateIdxStart, lastClient){
  const firstNonEmpty = row.findIndex(c => c && c !== "");
  if (firstNonEmpty === -1) return null;

  const cellA = (row[firstNonEmpty] || "").trim();
  const cellB = (row[firstNonEmpty+1] || "").trim();

  let client = cellA;
  let shift = "";

  if (cellA.includes("•")){
    const parts = cellA.split("•").map(x=>x.trim());
    client = parts[0] || cellA;
    shift = normalizeShift(parts[1] || "");
  } else {
    shift = normalizeShift(cellB);
    const solo = normalizeShift(cellA);
    if (solo && lastClient){
      client = lastClient;
      shift = solo;
    }
  }

  if (!shift){
    const solo = normalizeShift(cellA);
    if (solo && lastClient){
      client = lastClient;
      shift = solo;
    }
  }

  client = client || lastClient || "—";
  const alloc = row.slice(dateIdxStart).map(c => (c || "").trim().toUpperCase());
  return { client, shift, alloc };
}
function hasAnyActive(allocWin, activeCodes){
  if (activeCodes.size === 0) return true;
  return allocWin.some(v => activeCodes.has(v));
}

/* ===== Scroll sync (vertical entre panes / horizontal via barra fixa) ===== */
function bindScrollSync(){
  const left = $("leftScroll");
  const right = $("rightScroll");
  const bar = $("hscrollBar");

  let lockV = false;
  left.addEventListener("scroll", () => {
    if (lockV) return;
    lockV = true;
    right.scrollTop = left.scrollTop;
    requestAnimationFrame(()=>lockV=false);
  });
  right.addEventListener("scroll", () => {
    if (lockV) return;
    lockV = true;
    left.scrollTop = right.scrollTop;
    requestAnimationFrame(()=>lockV=false);
  });

  let lockH = false;
  bar.addEventListener("scroll", () => {
    if (lockH) return;
    lockH = true;
    right.scrollLeft = bar.scrollLeft;
    requestAnimationFrame(()=>lockH=false);
  });
  right.addEventListener("scroll", () => {
    if (lockH) return;
    lockH = true;
    bar.scrollLeft = right.scrollLeft;
    requestAnimationFrame(()=>lockH=false);
  });
}
function syncHScrollWidth(){
  const tbl = $("rightTable");
  const inner = $("hscrollInner");
  if (!tbl || !inner) return;
  inner.style.width = tbl.scrollWidth + "px";
}

/* ===== Render split tables ===== */
function rerender(){
  if (!state.cache) return;
  render(state.cache);
  syncHScrollWidth();
}
function render(cache){
  const { rawRows, dateIdxStart, dates, dows } = cache;

  const q = $("q").value.trim().toLowerCase();
  const start = normalizeDateLabel($("start").value.trim());
  const end   = normalizeDateLabel($("end").value.trim());

  const dateMask = dates.map(d => inWindow(d, start, end));
  const filteredDates = dates.filter((_,i)=>dateMask[i]);
  const filteredDows  = dows.filter((_,i)=>dateMask[i]);

  const activeCodes = getActiveCodes();
  const today = todayLabel();

  /* RIGHT HEAD (datas) */
  const rightHead = $("rightHead");
  rightHead.innerHTML = "";
  filteredDates.forEach((d, i) => {
    const th = document.createElement("th");
    th.innerHTML = `${filteredDows[i] ? filteredDows[i] + "<br/>" : ""}${d}`;
    rightHead.appendChild(th);
  });

  /* Normaliza linhas */
  let lastClient = "";
  const items = [];
  for (const r of rawRows){
    const parsed = getClientAndShift(r, dateIdxStart, lastClient);
    if (!parsed) continue;
    if (parsed.client && parsed.client !== "—") lastClient = parsed.client;
    items.push(parsed);
  }

  /* Agrupa por cliente (M/T) */
  const groups = [];
  const map = new Map();
  for (const it of items){
    const key = it.client;
    if (!map.has(key)){
      const g = { client: key, M: null, T: null };
      map.set(key, g);
      groups.push(g);
    }
    const g = map.get(key);
    if (it.shift === "M") g.M = it;
    if (it.shift === "T") g.T = it;
  }

  const leftBody = $("leftBody");
  const rightBody = $("rightBody");
  leftBody.innerHTML = "";
  rightBody.innerHTML = "";

  let lines = 0, filled = 0;

  function appendRowsForClient(g){
    // LEFT: cliente cell (rowspan visual com 2 rows)
    const trL1 = document.createElement("tr");
    const trL2 = document.createElement("tr");
    trL1.className = "row-m";
    trL2.className = "row-t";

    const tdClient = document.createElement("td");
    tdClient.className = "col-client";
    tdClient.rowSpan = 2;

    const box = document.createElement("div");
    box.className = "clientBox";
    const badge = document.createElement("div");
    badge.className = "clientBadge";
    badge.textContent = g.client || "—";
    box.appendChild(badge);
    tdClient.appendChild(box);

    const tdShiftM = document.createElement("td");
    tdShiftM.className = "col-shift";
    tdShiftM.textContent = "MANHÃ";

    const tdShiftT = document.createElement("td");
    tdShiftT.className = "col-shift";
    tdShiftT.textContent = "TARDE";

    trL1.appendChild(tdClient);
    trL1.appendChild(tdShiftM);
    trL2.appendChild(tdShiftT);

    leftBody.appendChild(trL1);
    leftBody.appendChild(trL2);

    // RIGHT: datas
    const trR1 = document.createElement("tr");
    const trR2 = document.createElement("tr");
    trR1.className = "row-m";
    trR2.className = "row-t";

    const allocM = (g.M && g.M.alloc) ? g.M.alloc : [];
    const allocT = (g.T && g.T.alloc) ? g.T.alloc : [];

    const winM = allocM.filter((_,i)=>dateMask[i]);
    const winT = allocT.filter((_,i)=>dateMask[i]);

    for (let i=0;i<filteredDates.length;i++){
      const rawM = (winM[i] || "").toUpperCase();
      const rawT = (winT[i] || "").toUpperCase();

      const shownM = (activeCodes.size === 0 || activeCodes.has(rawM)) ? rawM : "";
      const shownT = (activeCodes.size === 0 || activeCodes.has(rawT)) ? rawT : "";

      const tdM = document.createElement("td");
      tdM.appendChild(chip(shownM));
      if (filteredDates[i] === today) tdM.classList.add("today");
      if (shownM) filled++;

      const tdT = document.createElement("td");
      tdT.appendChild(chip(shownT));
      if (filteredDates[i] === today) tdT.classList.add("today");
      if (shownT) filled++;

      trR1.appendChild(tdM);
      trR2.appendChild(tdT);
    }

    rightBody.appendChild(trR1);
    rightBody.appendChild(trR2);

    lines += 2;
  }

  for (const g of groups){
    if (q && !g.client.toLowerCase().includes(q)) continue;

    const allocM = (g.M && g.M.alloc) ? g.M.alloc : [];
    const allocT = (g.T && g.T.alloc) ? g.T.alloc : [];
    const winM = allocM.filter((_,i)=>dateMask[i]);
    const winT = allocT.filter((_,i)=>dateMask[i]);

    // entra somente se houver ocorrência do filtro ativo (governança do filtro)
    if (!hasAnyActive(winM, activeCodes) && !hasAnyActive(winT, activeCodes)) continue;

    appendRowsForClient(g);
  }

  $("kpiRows").textContent = lines.toLocaleString("pt-BR");
  $("kpiCols").textContent = filteredDates.length.toLocaleString("pt-BR");
  $("kpiFilled").textContent = filled.toLocaleString("pt-BR");
  $("kpiToday").textContent = today;

  const sel = Array.from(activeCodes);
  const selTxt = sel.length ? ` • Filtro: ${sel.map(x=>`${x}=${RESOURCE_NAMES[x]}`).join(" | ")}` : "";
  $("status").textContent = `Status: carregado com sucesso (SSOT operacional).${selTxt}`;
  $("footRight").textContent = `Atualizado em ${new Date().toLocaleString("pt-BR")} • gid=${SHEET_GID}`;

  syncLegendUI();
}

/* ===== Load ===== */
async function load(){
  $("status").textContent = "Status: carregando…";

  const data = parseCSV(await fetchCSV());
  const cleaned = data.filter(r => r.some(c => c && c !== ""));

  if (cleaned.length < 3){
    $("status").textContent = "Status: CSV sem conteúdo útil (estrutura insuficiente).";
    return;
  }

  const dowRow  = cleaned[0];
  const dateRow = cleaned[1];

  const dateIdxStart = dateRow.findIndex(c => /^\d{1,2}\/\d{1,2}/.test(c));
  if (dateIdxStart === -1){
    $("status").textContent = "Status: não localizei coluna inicial de datas (dd/mm).";
    return;
  }

  const rawRows = cleaned.slice(2);
  const dates = dateRow.slice(dateIdxStart).map(normalizeDateLabel);
  const dows  = dowRow.slice(dateIdxStart).map(c => c || "");

  state.cache = { rawRows, dateIdxStart, dates, dows };
  render(state.cache);
  syncHeaderHeight();
  syncHScrollWidth();
}

/* ===== Events ===== */
function wire(){
  buildLegend();
  bindScrollSync();

  const rerun = () => rerender();

  ["q","start","end"].forEach(id => {
    $(id).addEventListener("input", rerun);
    $(id).addEventListener("change", rerun);
  });

  $("resource").addEventListener("change", () => {
    state.selected.clear();
    syncLegendUI();
    rerun();
  });

  $("btnReload").addEventListener("click", () => {
    state.cache = null;
    load().catch(err => {
      console.error(err);
      $("status").textContent = "Status: erro na carga. Validar CSV publicado (gid/endpoint).";
      $("footRight").textContent = err.message;
    });
  });

  load().catch(err => {
    console.error(err);
    $("status").textContent = "Status: erro na carga. Validar CSV publicado (gid/endpoint).";
    $("footRight").textContent = err.message;
  });
}

wire();
</script>
</body>
</html>
