<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel PMO - Gestão de Capacidade (Folha)</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e8efff;
      --muted:#93a4c7;
      --line:rgba(255,255,255,.10);

      --do:#60a5fa; --ge:#34d399; --jc:#fbbf24; --al:#fb7185;

      /* Ultra-denso */
      --rowH: 18px;
      --headH1: 14px;  /* linha DIA DA SEMANA */
      --headH2: 14px;  /* linha DATA */
      --headTotal: calc(var(--headH1) + var(--headH2));

      /* Larguras fixas (sem subpixel) */
      --wClient: 170px;
      --wTurno: 86px;

      /* Fundos sólidos (SEM transparência) */
      --solidBG: #0b1220;
      --solidHdr: #0a162e;
      --solidSticky: #0b1220;

      /* Faixas (sólidas) para manhã/tarde */
      --mStrip:#2b2a57;
      --tStrip:#0f3348;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(900px 500px at 20% 0%, #14264a 0%, var(--bg) 60%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow:hidden;
    }

    /* === CONTÊINER DO GRID COM SCROLL (VERTICAL + HORIZONTAL) === */
    .gridWrap{
      height: 100vh;
      padding:12px;
    }
    .gridCard{
      height: 100%;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:#0f1a30;
      display:flex;
      flex-direction:column;
    }

    .gridTitle{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      font-weight:900;
      background: var(--solidBG);
    }

    .tableScroll{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;           /* a rolagem acontece aqui */
      background: var(--solidBG);
      overscroll-behavior: contain;
    }

    table{
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
      width:max-content;
      min-width: 100%;
    }

    thead tr{ height: var(--headH1); }
    thead tr:nth-child(2){ height: var(--headH2); }
    tbody tr{ height: var(--rowH); }

    thead th{
      position: sticky;
      background: var(--solidHdr);
      color: var(--muted);
      border-bottom:1px solid rgba(255,255,255,.16);
      border-right:1px solid rgba(255,255,255,.06);
      text-align:center;
      padding:0 6px;
      white-space:nowrap;
      font-size:10px;
      font-weight:900;
      z-index: 10; /* base */
    }
    /* linha 1 do header (DOW) fica no topo */
    thead tr:nth-child(1) th{
      top: 0;
      height: var(--headH1);
      line-height: var(--headH1);
      z-index: 20;
    }
    /* linha 2 do header (DATA) fica logo abaixo */
    thead tr:nth-child(2) th{
      top: var(--headH1);
      height: var(--headH2);
      line-height: var(--headH2);
      z-index: 19;
    }

    /* =========================
       FIX DEFINITIVO:
       CABEÇALHO "CLIENTE" e "TURNO" NÃO PODE SUMIR
       -> sticky TOP + LEFT (4-way sticky)
       -> z-index acima de tudo
       ========================= */
    thead th.thClient{
      left: 0;
      width: var(--wClient);
      min-width: var(--wClient);
      max-width: var(--wClient);
      text-align:left;
      padding-left:10px;
      z-index: 1000;            /* acima do resto */
      background: var(--solidHdr);
      border-right:1px solid rgba(255,255,255,.14);
    }
    thead th.thTurno{
      left: var(--wClient);
      width: var(--wTurno);
      min-width: var(--wTurno);
      max-width: var(--wTurno);
      z-index: 999;             /* logo abaixo do Cliente */
      background: var(--solidHdr);
      border-right:1px solid rgba(255,255,255,.14);
    }

    /* Corpo */
    tbody td{
      height: var(--rowH);
      line-height: var(--rowH);
      font-size:11px;
      border-bottom:1px solid rgba(255,255,255,.06);
      border-right:1px solid rgba(255,255,255,.04);
      padding:0 4px;
      white-space:nowrap;
      background: var(--solidBG);
      vertical-align:middle;
    }

    /* Colunas fixas do corpo (Cliente/Turno) - não andam no scroll horizontal */
    tbody td.tdClient{
      position: sticky;
      left: 0;
      width: var(--wClient);
      min-width: var(--wClient);
      max-width: var(--wClient);
      z-index: 50;
      background: var(--solidSticky);
      border-right:1px solid rgba(255,255,255,.14);
    }
    tbody td.tdTurno{
      position: sticky;
      left: var(--wClient);
      width: var(--wTurno);
      min-width: var(--wTurno);
      max-width: var(--wTurno);
      z-index: 49;
      background: var(--solidSticky);
      border-right:1px solid rgba(255,255,255,.14);
      text-align:center;
      font-weight:900;
    }

    .clientText{
      display:block;
      padding:0 6px;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:900;
      text-transform:uppercase;
    }

    /* faixas manhã/tarde (no BODY todo) */
    tr.rowM td{ background: linear-gradient(90deg, var(--mStrip), var(--solidBG)); }
    tr.rowT td{ background: linear-gradient(90deg, var(--tStrip), var(--solidBG)); }
    /* mas as colunas fixas continuam sólidas */
    tr.rowM td.tdClient, tr.rowM td.tdTurno,
    tr.rowT td.tdClient, tr.rowT td.tdTurno{
      background: var(--solidSticky) !important;
    }

    /* Fim de semana */
    .weekend{ background:#2a2618 !important; }

    /* Chips */
    .cellChips{display:flex; align-items:center; justify-content:center; gap:2px;}
    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:22px; height:14px; padding:0 5px;
      border-radius:5px;
      border:1px solid rgba(255,255,255,.10);
      background:#14264a;
      font-weight:950;
      font-size:10px;
      line-height:14px;
      color:var(--text);
    }
    .empty{opacity:.25}
  </style>
</head>

<body>
  <div class="gridWrap">
    <div class="gridCard">
      <div class="gridTitle">Grade de Alocação</div>

      <div class="tableScroll" id="tableScroll">
        <table id="gridTable">
          <thead>
            <tr id="headDow"></tr>
            <tr id="headDate"></tr>
          </thead>
          <tbody id="body"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSgqs7bjsPeaojEQG7buOiixxv7tg1F6jt2wogHKI7O2AvjS-_aq6o7knAO5HgrUd5jZ1iWge4ZgMHM/pub?gid=0&single=true&output=csv";
const RESOURCE_NAMES = { DO:"Dôra", GE:"Geovana", JC:"João Custódio", AL:"Aline" };
const VALID = new Set(["DO","GE","JC","AL"]);

function parseCSV(text){
  const rows=[];
  let row=[], cur="", inQ=false;
  for (let i=0;i<text.length;i++){
    const ch=text[i], nx=text[i+1];
    if (ch === '"' && nx === '"'){ cur+='"'; i++; continue; }
    if (ch === '"'){ inQ=!inQ; continue; }
    if (ch === ',' && !inQ){ row.push(cur); cur=""; continue; }
    if ((ch === '\n' || ch === '\r') && !inQ){
      if (cur.length || row.length){ row.push(cur); rows.push(row); }
      row=[]; cur=""; continue;
    }
    cur+=ch;
  }
  if (cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows.map(r=>r.map(c=>(c??"").trim()));
}

function normalizeDateLabel(s){
  const m=String(s||"").trim().match(/^(\d{1,2})\/(\d{1,2})/);
  if(!m) return String(s||"").trim();
  return `${String(m[1]).padStart(2,"0")}/${String(m[2]).padStart(2,"0")}`;
}

function isWeekend(dow){
  const x=String(dow||"").toUpperCase();
  return x.startsWith("SAB") || x.startsWith("SÁB") || x.startsWith("DOM");
}

function parseCellCodes(cellRaw){
  const raw=String(cellRaw||"").trim();
  if(!raw) return [];
  const normalized = raw.toUpperCase()
    .replace(/\u00A0/g," ")
    .replace(/[\n\r\t]/g," ")
    .replace(/[\/,;|]/g," ")
    .replace(/\s*-\s*/g," ");
  const parts=normalized.split(/\s+/).filter(Boolean);
  const out=[], seen=new Set();
  for(const p of parts){
    const code=p.replace(/[^A-Z]/g,"").slice(0,2);
    if(!VALID.has(code)) continue;
    if(seen.has(code)) continue;
    seen.add(code); out.push(code);
  }
  return out;
}

function chipEl(code){
  const v=String(code||"").toUpperCase().trim();
  const sp=document.createElement("span");
  sp.className="chip"+(!v?" empty":"");
  sp.textContent=v || "—";
  if(RESOURCE_NAMES[v]) sp.title=`${v} = ${RESOURCE_NAMES[v]}`;
  const css=getComputedStyle(document.documentElement);
  const colors={ DO:css.getPropertyValue("--do").trim(), GE:css.getPropertyValue("--ge").trim(), JC:css.getPropertyValue("--jc").trim(), AL:css.getPropertyValue("--al").trim() };
  if(colors[v]){
    sp.style.background=colors[v];
    sp.style.color="#0b1220";
  }
  return sp;
}

/* ===== RENDER ===== */
async function load(){
  const res=await fetch(CSV_URL, {cache:"no-store"});
  if(!res.ok) throw new Error("Falha ao buscar CSV");
  const csv=await res.text();
  const rows=parseCSV(csv).filter(r=>r.some(c=>c && c!==""));
  if(rows.length<3) return;

  const dowRow=rows[0];
  const dateRow=rows[1];

  const dateIdxStart = dateRow.findIndex(c=>/^\d{1,2}\/\d{1,2}/.test(c));
  if(dateIdxStart<0) return;

  const dows = dowRow.slice(dateIdxStart);
  const dates = dateRow.slice(dateIdxStart).map(normalizeDateLabel);

  // Header (linha 1 e 2) + CLIENTE/TURNO 4-way sticky
  const headDow=document.getElementById("headDow");
  const headDate=document.getElementById("headDate");
  headDow.innerHTML=""; headDate.innerHTML="";

  const thClient=document.createElement("th");
  thClient.className="thClient";
  thClient.textContent="Cliente";
  thClient.rowSpan=2;

  const thTurno=document.createElement("th");
  thTurno.className="thTurno";
  thTurno.textContent="Turno";
  thTurno.rowSpan=2;

  headDow.appendChild(thClient);
  headDow.appendChild(thTurno);

  for(let i=0;i<dates.length;i++){
    const th=document.createElement("th");
    th.textContent=(dows[i]||"").toUpperCase();
    th.style.width="64px"; th.style.minWidth="64px"; th.style.maxWidth="64px";
    if(isWeekend(dows[i])) th.classList.add("weekend");
    headDow.appendChild(th);
  }
  for(let i=0;i<dates.length;i++){
    const th=document.createElement("th");
    th.textContent=dates[i];
    th.style.width="64px"; th.style.minWidth="64px"; th.style.maxWidth="64px";
    if(isWeekend(dows[i])) th.classList.add("weekend");
    headDate.appendChild(th);
  }

  // Body
  const body=document.getElementById("body");
  body.innerHTML="";

  let lastClient="";
  for(let r=2;r<rows.length;r++){
    const row=rows[r];

    // tentar identificar cliente e turno (M/T) no começo da linha
    const first=row.findIndex(c=>c && c!=="");
    if(first<0) continue;

    let client=(row[first]||"").trim();
    let turno=(row[first+1]||"").trim();

    // Se vier linha só com "T" ou "M", reaproveita último cliente
    const t=(x)=>String(x||"").toUpperCase().trim();
    const isM = (x)=> (t(x)==="M" || t(x)==="MANHÃ" || t(x)==="MANHA");
    const isT = (x)=> (t(x)==="T" || t(x)==="TARDE");

    if(isM(client) || isT(client)){
      turno = client;
      client = lastClient || "—";
    }
    if(client && client!=="—") lastClient=client;

    const turnoNorm = isM(turno) ? "MANHÃ" : (isT(turno) ? "TARDE" : turno);
    const tr=document.createElement("tr");
    tr.className = (turnoNorm==="MANHÃ") ? "rowM" : "rowT";

    const tdClient=document.createElement("td");
    tdClient.className="tdClient";
    const span=document.createElement("span");
    span.className="clientText";
    span.textContent=client;
    tdClient.appendChild(span);

    const tdTurno=document.createElement("td");
    tdTurno.className="tdTurno";
    tdTurno.textContent=turnoNorm || "—";

    tr.appendChild(tdClient);
    tr.appendChild(tdTurno);

    const cells=row.slice(dateIdxStart);
    for(let i=0;i<dates.length;i++){
      const td=document.createElement("td");
      td.style.width="64px"; td.style.minWidth="64px"; td.style.maxWidth="64px";
      if(isWeekend(dows[i])) td.classList.add("weekend");

      const codes=parseCellCodes(cells[i]||"");
      const box=document.createElement("div");
      box.className="cellChips";
      if(!codes.length){
        box.appendChild(chipEl(""));
      }else{
        for(const c of codes) box.appendChild(chipEl(c));
      }
      td.appendChild(box);
      tr.appendChild(td);
    }

    body.appendChild(tr);
  }
}

load().catch(console.error);
</script>
</body>
</html>
